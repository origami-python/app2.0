<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ç¤¾ä¼šã‚¯ã‚¤ã‚º v2.1ï¼ˆH1ã€œH5æ‹¡å¼µï¼‰</title>
<meta name="theme-color" content="#d71a1a">
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./assets/icon512.png">
<style>
  @font-face{
    font-family:"PressStart";
    src:url("https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nYhD8.woff2") format("woff2");
    font-display:swap;
  }
  :root{
    --bg:#0c0c0c; --card:#141414; --ink:#f2f2f2; --sub:#bfbfbf;
    --acc:#d71a1a; --ok:#2ecc40; --ng:#ff4136; --edge:#2a2a2a;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#0c0c0c;color:var(--ink);font:15px/1.7 "Noto Sans JP",system-ui,Segoe UI,Arial;}
  header,footer{position:sticky;z-index:5;background:#0b0b0b;border-bottom:1px solid var(--edge)}
  header{top:0} footer{bottom:0;border-bottom:none;border-top:1px solid var(--edge)}
  .bar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:8px}
  .title{font-family:"PressStart",monospace;letter-spacing:1px;font-size:12px}
  .badge{background:#222;border:2px solid #444;border-radius:6px;padding:6px 8px}
  .main{max-width:1100px;margin:12px auto 90px;padding:0 12px;display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:1024px){ .main{ grid-template-columns:1.25fr .85fr; } }
  .card{background:var(--card);border:3px solid #333;border-radius:10px;padding:12px}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button{background:#1a1a1a;border:3px solid #333;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  .primary{background:var(--acc);border-color:#861010}
  .ghost{background:#151515}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:3px solid #333;border-radius:999px;background:#131313;color:#eee;text-decoration:none}
  .ok{color:var(--ok)} .ng{color:var(--ng)} .tiny{color:var(--sub);font-size:12px}
  .qimg{max-height:220px;width:100%;object-fit:cover;border-radius:8px;border:3px solid #333;display:none}
  .opt{padding:10px;border:3px solid #333;border-radius:8px;cursor:pointer;background:#121212}
  .opt.correct{background:#0f2412;border-color:#1e4d2a}
  .opt.incorrect{background:#2a0f0f;border-color:#5a1f1f}
  .list{display:grid;gap:8px;max-height:330px;overflow:auto}
  .kpi{background:#0f0f0f;border:3px solid #333;border-radius:8px;padding:8px}
  .pack{display:flex;align-items:center;gap:8px;padding:8px;border:3px solid #333;border-radius:8px;background:#101010}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center}
  .dialog{max-width:900px;width:92%;max-height:85vh;overflow:auto;background:#0f0f0f;border:3px solid #333;border-radius:12px;padding:12px}
  /* Startç”»é¢ */
  #startOverlay{position:fixed;inset:0;background:
    radial-gradient(1200px 600px at 50% -20%, rgba(215,26,26,.35), transparent),
    #050505; display:flex;align-items:center;justify-content:center;z-index:9999;}
  .startPanel{ text-align:center; }
  .startTitle{ font-family:"PressStart",monospace; font-size:20px; margin:0 0 18px; letter-spacing:1px }
  .startBtn{ font-family:"PressStart",monospace; padding:14px 22px; font-size:12px }
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .grp{border:2px dashed #444;border-radius:10px;padding:8px}
  .grp h4{margin:0 0 6px}
  label.cb{display:flex;align-items:center;gap:6px;padding:6px 8px;border:2px solid #333;border-radius:8px;background:#0f0f0f}
</style>
</head>
<body>
  
<!-- Start / ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚° -->
<div id="startOverlay">
  <div class="startPanel">
    <div class="startTitle">SOCIAL QUIZ</div>
    <div class="card" style="min-width: 280px; text-align:left">
      <h4 style="margin:6px 0 8px">ã‚¸ãƒ£ãƒ³ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</h4>
      <div class="grid3 tiny">
        <div class="grp"><h4>æ­´å²ï¼ˆH1ã€œH5ï¼‰</h4>
          <label class="cb"><input type="checkbox" data-cat value="H1" checked> åŸå§‹ã€œå¤ä»£ï¼ˆH1ï¼‰</label>
          <label class="cb"><input type="checkbox" data-cat value="H2" checked> å¹³å®‰ï¼ˆH2ï¼‰</label>
          <label class="cb"><input type="checkbox" data-cat value="H3" checked> éŒå€‰ã€œå®¤ç”ºï¼ˆH3ï¼‰</label>
          <label class="cb"><input type="checkbox" data-cat value="H4" checked> æ¡ƒå±±ã€œæ±Ÿæˆ¸ï¼ˆH4ï¼‰</label>
          <label class="cb"><input type="checkbox" data-cat value="H5" checked> è¿‘ç¾ä»£ï¼ˆH5ï¼‰</label>
        </div>
        <div class="grp"><h4>åœ°ç†ï¼ˆGï¼‰</h4>
          <label class="cb"><input type="checkbox" data-cat value="G1" checked> æ—¥æœ¬åœ°ç†ï¼ˆG1ï¼‰</label>
          <label class="cb"><input type="checkbox" data-cat value="G2" checked> ä¸–ç•Œåœ°ç†ï¼ˆG2ï¼‰</label>
        </div>
        <div class="grp"><h4>å…¬æ°‘ãƒ»è³‡æ–™ï¼ˆC/Mï¼‰</h4>
          <label class="cb"><input type="checkbox" data-cat value="C1" checked> å…¬æ°‘ã¨æ”¿æ²»ï¼ˆC1ï¼‰</label>
          <label class="cb"><input type="checkbox" data-cat value="C2" checked> çµŒæ¸ˆã¨å›½éš›ï¼ˆC2ï¼‰</label>
          <label class="cb"><input type="checkbox" data-cat value="M1" checked> èåˆãƒ»è³‡æ–™èª­è§£ï¼ˆM1ï¼‰</label>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="qCount" type="number" min="30" max="300" value="300" style="width:110px;background:#0f0f0f;border:2px solid #333;border-radius:8px;color:#fff;padding:6px">
        <button id="startBtn" class="startBtn primary">â–¶ï¸ STARTï¼ˆBGMã‚ã‚Šï¼‰</button>
      </div>
      <div class="tiny" style="margin-top:8px">â€»Startã§8bit BGMã‚’è‡ªå‹•å†ç”Ÿã€‚ã„ã¤ã§ã‚‚ãƒŸãƒ¥ãƒ¼ãƒˆã—ãŸã„å ´åˆã¯ç«¯æœ«ã®éŸ³é‡ã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚</div>
    </div>
  </div>
</div>

<header>
  <div class="bar">
    <div class="title">SOCIAL QUIZ â€¢ RETRO</div>
    <div class="badge">v2.1</div>
    <div style="margin-left:auto" class="row">
      <button id="refreshBtn" class="ghost">æ–°è¦300å•ã‚’å†ç”Ÿæˆ</button>
      <button id="updateBtn" class="primary">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ›´æ–°ï¼ˆWikipediaï¼‰</button>
    </div>
  </div>
</header>

<main class="main">
  <section class="card" id="left"></section>
  <aside class="card" id="right">
    <h3 style="margin:0 0 8px">é€²æ— / ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
    <div id="progress"></div>
    <h3 style="margin:12px 0 8px">ãƒ‘ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰</h3>
    <div id="packs" class="list tiny"></div>
  </aside>
</main>

<footer>
  <div class="bar tiny">
    <div>ãƒ‡ãƒ¼ã‚¿ï¼š<code>data/seeds/*.json</code> â†’ è‡ªå‹•ã§300å•ç”Ÿæˆ ï¼ PWAå¯¾å¿œï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ OKï¼‰</div>
  </div>
</footer>

<!-- æ¡ç‚¹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="resultOverlay" class="overlay" style="display:none" aria-hidden="true">
  <div class="dialog">
    <h3>å­¦ç¿’çµæœï¼ˆä»Šå›ï¼‰</h3>
    <div id="sum" class="row" style="margin:8px 0"></div>
    <div id="hist" class="list tiny"></div>
    <div class="row" style="justify-content:end;margin-top:10px">
      <button class="ghost" id="closeResult">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script>
/* ========= PWA ========= */
if ('serviceWorker' in navigator) {
  addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.warn));
}

/* ========= WebAudioï¼ˆ8bit BGM & SEï¼‰ ========= */
const AudioKit = (() => {
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const master = ctx.createGain(); master.gain.value = 0.22; master.connect(ctx.destination);

  function tone(freq=440, t=0.12, type='square', v=0.7){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master);
    const now=ctx.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(v, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+t);
    o.start(now); o.stop(now+t+0.02);
  }
  // 8bitãƒ«ãƒ¼ãƒ—BGMï¼ˆç´„5ç§’ / 120bpm / Cãƒ¡ã‚¸ãƒ£ãƒ¼ï¼šã‚¢ãƒ«ãƒšã‚¸ã‚ªï¼‹ãƒ™ãƒ¼ã‚¹ï¼‰
  let bgmSeq=null;
  function startBGM(){
    stopBGM();
    const bpm=120, beat=60/bpm;
    bgmSeq = setInterval(()=>{
      const base=261.6; // C4
      // ãƒ™ãƒ¼ã‚¹
      tone(base/2, beat*0.4,'square',0.5);
      setTimeout(()=>tone(base*1.5/2, beat*0.4,'square',0.5), beat*500);
      // ã‚¢ãƒ«ãƒšã‚¸ã‚ª
      setTimeout(()=>tone(base, beat*0.18,'square',0.35), beat*100);
      setTimeout(()=>tone(base*5/4, beat*0.18,'square',0.35), beat*200);
      setTimeout(()=>tone(base*3/2, beat*0.18,'square',0.35), beat*300);
      setTimeout(()=>tone(base*2, beat*0.18,'square',0.35), beat*400);
      // ãƒªãƒ¼ãƒ‰ï¼ˆå°è±¡ãƒ¡ãƒ­ï¼‰
      setTimeout(()=>tone(523.25, beat*0.25,'triangle',0.45), beat*150);
      setTimeout(()=>tone(659.25, beat*0.25,'triangle',0.45), beat*250);
      setTimeout(()=>tone(783.99, beat*0.25,'triangle',0.45), beat*350);
    }, beat*1000*4);
  }
  function stopBGM(){ if(bgmSeq){ clearInterval(bgmSeq); bgmSeq=null; } }

  // SE
  const sfx = {
    select: ()=>tone(660,0.06,'square',0.5),
    correct: ()=>{ tone(880,0.09,'square',0.6); setTimeout(()=>tone(1175,0.10,'triangle',0.6),80); }, // ãƒ”ãƒ³ãƒãƒ¼ãƒ³ï¼
    wrong: ()=>{ tone(196,0.12,'square',0.6); setTimeout(()=>tone(155,0.14,'square',0.6),90); } // ãƒ–ãƒƒãƒ–ãƒ¼ï¼
  };
  return { ctx, startBGM, stopBGM, sfx };
})();

/* ========= Startç”»é¢ ========= */
const startOverlay = document.getElementById('startOverlay');
document.getElementById('startBtn').onclick = async ()=>{
  // AudioKit.startBGM(); // æ—§BGMã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã§å‰Šé™¤ã—ã¾ã—ãŸ
  const cats = [...document.querySelectorAll('input[data-cat]:checked')].map(el=>el.value);
  const total = Math.max(30, Math.min(300, parseInt(document.getElementById('qCount').value||300,10)));
  await generateQuestions(cats, total); // ã“ã“ã§300å•ç”Ÿæˆ
  startOverlay.style.display='none';
  buildQueue(); mountQuestion(); renderRight();
};

/* ========= çŠ¶æ…‹ç®¡ç† ========= */
const APP='socquiz_v2_21';
const store = {
  data: JSON.parse(localStorage.getItem(APP) || '{"cards":[],"stats":{"answered":0,"correct":0,"streak":0,"points":0},"session":[]}'),
  save(){ localStorage.setItem(APP, JSON.stringify(this.data)); },
  reset(){ localStorage.removeItem(APP); location.reload(); }
};
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a;}
function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function pct(a,b){return !b?0:Math.round(a/b*100);}

/* ========= ã‚·ãƒ¼ãƒ‰èª­è¾¼ & 300å•è‡ªå‹•ç”Ÿæˆ ========= */
/* ã‚·ãƒ¼ãƒ‰å½¢å¼ï¼ˆä¾‹ï¼‰ï¼š
  { "type":"event_year", "term":"å…ƒå¯‡ï¼ˆæ–‡æ°¸ã®å½¹ï¼‰", "year":1274, "category":"H3", "hint":"éŒå€‰æ™‚ä»£ã€æœ€åˆã®è¥²æ¥" }
  { "type":"term_def",   "term":"å£åˆ†ç”°", "definition":"å¾‹ä»¤åˆ¶ã§6æ­³ä»¥ä¸Šã«æ”¯çµ¦ã•ã‚ŒãŸç”°åœ°", "category":"H1" }
  { "type":"geo_match",  "term":"å…¼å…­åœ’", "definition":"é‡‘æ²¢å¸‚ã®å¤§ååº­åœ’ï¼ˆæ—¥æœ¬ä¸‰ååœ’ï¼‰", "category":"G1" }
  { "type":"civics",     "term":"ç”Ÿå­˜æ¨©", "definition":"å¥åº·ã§æ–‡åŒ–çš„ãªæœ€ä½é™åº¦ã®ç”Ÿæ´»ï¼ˆæ†²æ³•25æ¡ï¼‰", "category":"C1" }
*/
const SEED_FILES = [
  'H1_ancient','H2_heian','H3_kamakura_muromachi','H4_edo','H5_modern',
  'G1_japan_geo','G2_world_geo','C1_civics_politics','C2_econ_international','M1_data_reading'
];
async function loadSeeds(filterCats=null){
  const base='./data/seeds/';
  const use = filterCats? SEED_FILES.filter(n=>filterCats.some(c=>n.startsWith(c))) : SEED_FILES;
  let pool=[];
  for(const name of use){
    try{
      const r=await fetch(base+name+'.json?v='+Date.now(),{cache:'no-store'});
      if(r.ok){ const j=await r.json(); pool.push(...j); }
    }catch{}
  }
  return pool;
}
function mcFromYear(seed, distractorPool){
  const correct = String(seed.year);
  const near = distractorPool
    .filter(s=>s.type==='event_year' && s.category===seed.category && s.term!==seed.term)
    .map(s=>String(s.year));
  const choices = shuffle([correct, ...shuffle(near).slice(0,3)]);
  return {
    id: `y_${seed.category}_${seed.term}_${seed.year}`,
    category: seed.category, domain:'æ­´å²', question_type:'mc', difficulty:2,
    question: `${seed.term}ãŒèµ·ã“ã£ãŸè¥¿æš¦ã¯ï¼Ÿ`,
    choices, answer: correct,
    explanation: seed.hint || 'å¹´å·ã¯ä¸¦ã¹æ›¿ãˆå•é¡Œã§ã‚‚é »å‡ºã€‚',
    tags:[seed.term,'å¹´å·']
  };
}
function mcFromDef(seed, distractorPool){
  const correct = seed.term;
  const near = distractorPool
    .filter(s=>s.type===seed.type && s.category===seed.category && s.term!==seed.term)
    .map(s=>s.term);
  const choices = shuffle([correct, ...shuffle(near).slice(0,3)]);
  return {
    id:`t_${seed.category}_${seed.term}`,
    category: seed.category, domain: (seed.category.startsWith('G')?'åœ°ç†':seed.category.startsWith('C')?'å…¬æ°‘':'æ­´å²'),
    question_type:'mc', difficulty:1,
    question:`ã€Œ${seed.definition}ã€ã«å½“ã¦ã¯ã¾ã‚‹èªå¥ã¯ï¼Ÿ`,
    choices, answer: correct,
    explanation: seed.hint || 'ç”¨èªã®å®šç¾©ã‚’æ­£ç¢ºã«è¦šãˆã‚ˆã†ã€‚',
    tags:[seed.term]
  };
}
function mcFromMatch(seed, distractorPool){
  // åœ°ç†ãƒ»è³‡æ–™èª­è§£ã§ç”¨èªâ‡„èª¬æ˜ã®é€†å¼•ã
  const correct = seed.definition;
  const near = distractorPool
    .filter(s=>s.type===seed.type && s.category===seed.category && s.term!==seed.term)
    .map(s=>s.definition);
  const choices = shuffle([correct, ...shuffle(near).slice(0,3)]);
  return {
    id:`g_${seed.category}_${seed.term}`,
    category: seed.category, domain: (seed.category.startsWith('G')?'åœ°ç†':'èåˆ'),
    question_type:'mc', difficulty:2,
    question:`${seed.term}ã®èª¬æ˜ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã®ã¯ï¼Ÿ`,
    choices, answer: correct,
    explanation: seed.hint || 'ç´›ã‚‰ã‚ã—ã„ç”¨èªã¨åŒºåˆ¥ã—ã‚ˆã†ã€‚',
    tags:[seed.term]
  };
}
function makeMC(seed, all){
  if(seed.type==='event_year') return mcFromYear(seed, all);
  if(seed.type==='term_def' || seed.type==='civics') return mcFromDef(seed, all);
  if(seed.type==='geo_match') return mcFromMatch(seed, all);
  // fallback
  return mcFromDef(seed, all);
}
async function generateQuestions(categories, totalCount){
  const seeds = await loadSeeds(categories);
  if(!seeds.length){ alert('ã‚·ãƒ¼ãƒ‰ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸï¼ˆdata/seeds é…ç½®ã‚’ç¢ºèªï¼‰'); return; }
  // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®é…åˆ†ï¼ˆæ­´å²æ¯”ç‡é«˜ã‚ï¼‰
  const baseShare = {
    H1: 0.12, H2: 0.08, H3: 0.12, H4: 0.14, H5: 0.14, // æ­´å² åˆè¨ˆ0.60
    G1: 0.10, G2: 0.10, // åœ°ç† 0.20
    C1: 0.08, C2: 0.06, // å…¬æ°‘ 0.14
    M1: 0.06           // è³‡æ–™ 0.06
  };
  const selected = categories.length? categories : Object.keys(baseShare);
  const totalShare = selected.reduce((s,c)=>s+(baseShare[c]||0),0) || 1;
  const targets = Object.fromEntries(selected.map(c=>{
    const n = Math.max(5, Math.round(totalCount * (baseShare[c]||0)/totalShare));
    return [c,n];
  }));
  const byCat = s=>seeds.filter(x=>x.category===s);
  let cards=[];
  for(const cat of selected){
    const pool = byCat(cat);
    const want = targets[cat]||0;
    // ã‚·ãƒ¼ãƒ‰ä¸è¶³æ™‚ã¯ä»–catã‹ã‚‰è£œå®Œ
    const use = pool.length? shuffle(pool).slice(0, Math.min(pool.length, want)) : [];
    const gen = use.map(seed=>makeMC(seed, pool));
    // è¶³ã‚Šãªã„åˆ†ã¯åŒã‚«ãƒ†ã‚´ãƒªã‹ã‚‰é‡è¤‡è¨±å®¹ã§è¿½åŠ 
    while(gen.length < want && pool.length){
      const seed = pool[Math.floor(Math.random()*pool.length)];
      gen.push(makeMC(seed, pool));
    }
    cards.push(...gen);
  }
  // å…¨ä½“ã®ä¸è¶³ã‚’å…¨ç¨®ã‹ã‚‰è£œå®Œ
  while(cards.length < totalCount){
    const seed = seeds[Math.floor(Math.random()*seeds.length)];
    cards.push(makeMC(seed, seeds));
  }
  // ä»•ä¸Šã’ï¼šIDé‡è¤‡è§£æ¶ˆ
  const uniq = []; const seen=new Set();
  for(const c of cards){
    let id = c.id, k=1;
    while(seen.has(id)){ id = c.id+'_'+(++k); }
    c.id=id; seen.add(id);
    // YouTubeç”¨ã®ãƒ¡ã‚¿ã‚’è»½ã
    c.source = c.source || {type:'seed', note:c.category};
    c.tags = c.tags || [];
  }
  store.data.cards = uniq.concat(cards); // uniqã¯ç©ºã ãŒå°†æ¥ã®é‡è¤‡æ’é™¤ç”¨
  store.data.stats = {answered:0,correct:0,streak:0,points:0};
  store.data.session=[];
  store.save();
}

/* ========= YouTubeãƒªãƒ³ã‚¯ ========= */
const ytChannelSearch = q => `https://www.youtube.com/@eva11100/search?query=${encodeURIComponent(q)}`;
const ytGeneralSearch = q => `https://www.youtube.com/results?search_query=${encodeURIComponent(q+' é«˜æ ¡å…¥è©¦ ç¤¾ä¼š')}`;
function ytButtonsFor(qobj){
  const key = qobj.answer || qobj.question || '';
  if(!/[ä¸€-é¾¥A-Za-z0-9]/.test(key)) return '';
  const q = key.replace(/ï¼ˆ.*?ï¼‰/g,'');
  return `
    <a class="pill" target="_blank" rel="noopener" href="${ytChannelSearch(q)}">â–¶ ãƒãƒ£ãƒ³ãƒãƒ«ã§å­¦ã¶</a>
    <a class="pill" target="_blank" rel="noopener" href="${ytGeneralSearch(q)}">â–¶ YouTubeã§æ¤œç´¢</a>
  `;
}

/* ========= Quiz Engineï¼ˆå›ç­”â†’è§£èª¬ã§åœæ­¢ï¼‰ ========= */
let queue=[], current=null;
function buildQueue(){ queue = shuffle([...store.data.cards]); }
function mountQuestion(){
  const L=document.getElementById('left');
  if(!current){ current = queue.shift() || store.data.cards[Math.floor(Math.random()*store.data.cards.length)]; }
  const c=current;
  const ops = Array.isArray(c.choices)
    ? c.choices.map(ch=>`<label class="opt"><input type="radio" name="choice" value="${esc(ch)}"> ${esc(ch)}</label>`).join('')
    : `<input id="free" type="text" placeholder="è§£ç­”ã‚’å…¥åŠ›">`;
  L.innerHTML = `
    <div class="tiny">ã‚«ãƒ†ã‚´ãƒª: ${esc(c.category)} ï¼ å‡ºå…¸: ${esc(c.source?.note||'seed')}</div>
    <h3 style="margin:.2rem 0 0.8rem">${esc(c.question)}</h3>
    <div id="ops" class="list">${ops}</div>
    <div class="row" style="margin-top:10px">
      <button class="primary" id="answerBtn">å›ç­”ã™ã‚‹</button>
      <button class="ghost" id="skipBtn">ã‚¹ã‚­ãƒƒãƒ—</button>
      <button class="pill" id="gradeBtn">æ¡ç‚¹ã™ã‚‹</button>
      ${ytButtonsFor(c)}
    </div>
    <div id="fb" style="margin-top:10px"></div>
  `;
  renderRight();
  document.getElementById('answerBtn').onclick = checkAnswer;
  document.getElementById('skipBtn').onclick   = ()=>{ current=null; AudioKit.sfx.select(); mountQuestion(); };
  document.getElementById('gradeBtn').onclick  = openResults;
}
function checkAnswer(){
  const c=current; const fb=document.getElementById('fb');
  let ua='';
  const radio = document.querySelector('input[name="choice"]');
  if(radio){
    const sel=document.querySelector('input[name="choice"]:checked');
    if(!sel){ fb.innerHTML='<div class="tiny">é¸æŠè‚¢ã‚’é¸ã‚“ã§ã­ã€‚</div>'; return; }
    ua=sel.value;
    document.querySelectorAll('.opt').forEach(el=>{
      const v=el.querySelector('input').value;
      el.classList.toggle('correct', v===c.answer);
      if(v===ua && ua!==c.answer) el.classList.add('incorrect');
      el.querySelector('input').disabled=true;
    });
  }else{
    ua=(document.getElementById('free').value||'').trim();
  }
  const ok = String(ua)===String(c.answer);
  if(ok){ store.data.stats.correct++; store.data.stats.streak++; store.data.stats.points+=10; AudioKit.sfx.correct(); }
  else  { store.data.stats.streak=0; AudioKit.sfx.wrong(); }
  store.data.stats.answered++;
  store.data.session.push({q:c.question, ua, ans:c.answer, ok, explain:c.explanation||'', cat:c.category});
  store.save();
  fb.innerHTML = `
    <div class="${ok?'ok':'ng'}">${ok?'ğŸ‰ æ­£è§£ï¼ +10pt':'ğŸ’¡ ä¸æ­£è§£â€¦â€¦'}</div>
    <div class="tiny">è§£èª¬ï¼š${esc(c.explanation||'â€”')}</div>
    <div class="row" style="margin-top:10px">
      <button class="primary" id="nextBtn">æ¬¡ã®å•é¡Œã¸</button>
      <button class="ghost" id="gradeNowBtn">æ¡ç‚¹ã™ã‚‹</button>
    </div>
  `;
  document.getElementById('nextBtn').onclick=()=>{ current=null; mountQuestion(); };
  document.getElementById('gradeNowBtn').onclick=openResults;
  renderRight();
}

/* ========= å³ãƒ‘ãƒãƒ« ========= */
function renderRight(){
  const s=store.data.stats, R=document.getElementById('right');
  R.innerHTML = `
    <div id="progress">
      <div class="row">
        <div class="kpi">è§£ã„ãŸæ•°ï¼š${s.answered}</div>
        <div class="kpi">æ­£è§£æ•°ï¼š${s.correct}</div>
        <div class="kpi">æ­£ç­”ç‡ï¼š${pct(s.correct, s.answered)}%</div>
        <div class="kpi">é€£ç¶šæ­£è§£ï¼š${s.streak}</div>
        <div class="kpi">ãƒã‚¤ãƒ³ãƒˆï¼š${s.points}</div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="ghost" onclick="store.reset()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        <button class="ghost" id="backup">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <input type="file" id="restoreFile" style="display:none" accept="application/json">
        <button class="ghost" id="restoreBtn">å¾©å…ƒ</button>
      </div>
    </div>
    <div id="packs" class="list tiny"></div>
  `;
  document.getElementById('backup').onclick=()=>{
    const blob = new Blob([JSON.stringify(store.data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='socquiz_v21_backup.json'; a.click();
  };
  document.getElementById('restoreBtn').onclick=()=>{
    const f=document.getElementById('restoreFile'); f.onchange=()=>{
      const file=f.files[0]; const r=new FileReader();
      r.onload=()=>{ try{ store.data=JSON.parse(r.result); store.save(); location.reload(); }catch{ alert('å¾©å…ƒå¤±æ•—'); } };
      r.readAsText(file);
    }; f.click();
  };
  renderPackUI();
}

/* ========= ãƒ‘ãƒƒã‚¯UIï¼ˆä»»æ„ï¼‰ ========= */
async function loadPackIndex(){
  try{ const res=await fetch('./data/index.json?v='+Date.now(),{cache:'no-store'}); if(!res.ok) throw 0; return await res.json(); }
  catch{ return []; }
}
async function loadPacks(selected){
  const base='./data/packs/'; const loaded=[];
  for(const p of selected){
    try{ const r=await fetch(`${base}${p}.json?v=${Date.now()}`,{cache:'no-store'}); if(r.ok) loaded.push(...await r.json()); }catch{}
  }
  const ids=new Set((store.data.cards||[]).map(c=>String(c.id)));
  const add=loaded.filter(q=>!ids.has(String(q.id))).map(q=>({
    id:q.id, category:q.category||'M1', domain:q.domain||'ç·åˆ', question_type:q.question_type||'mc',
    question:q.question, choices:q.choices, answer:q.answer,
    explanation:q.explanation||'', image:q.image||null,
    source:q.source||{type:'pack',note:'packs'}, tags:q.tags||[]
  }));
  store.data.cards.push(...add); store.save(); return add.length;
}
async function renderPackUI(){
  const list=await loadPackIndex(); const el=document.getElementById('packs');
  el.innerHTML = list.length ? '' : '<div>ä»»æ„ã®è¿½åŠ ãƒ‘ãƒƒã‚¯ã‚’ data/index.json ã«ç™»éŒ²ã§ãã¾ã™ã€‚</div>';
  list.forEach(p=>{
    const id='pack_'+p.pack;
    el.insertAdjacentHTML('beforeend', `
      <label class="pack">
        <input type="checkbox" id="${id}" data-pack="${p.pack}" ${p.recommended?'checked':''}
               onclick="AudioKit.sfx.select()">
        <div><b>${esc(p.title)}</b><br><span class="tiny">${esc(p.pack)} / ${p.count}å•</span></div>
      </label>
    `);
  });
  const btn=document.createElement('button');
  btn.textContent='é¸æŠãƒ‘ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã‚€'; btn.className='primary';
  btn.onclick=async()=>{ const packs=[...document.querySelectorAll('[id^="pack_"]:checked')].map(x=>x.dataset.pack);
    const n=await loadPacks(packs);
    if(n>0){ buildQueue(); mountQuestion(); alert(`${n}å•ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`); } else { alert('æ–°è¦ã¯ã‚ã‚Šã¾ã›ã‚“'); }
  };
  el.appendChild(btn);
}

/* ========= æ¡ç‚¹ãƒ¢ãƒ¼ãƒ€ãƒ« ========= */
function openResults(){
  const ov=document.getElementById('resultOverlay'), sum=document.getElementById('sum'), hist=document.getElementById('hist');
  const S=store.data.stats, H=store.data.session;
  sum.innerHTML = `<div class="kpi">ä»Šå›ã®å•é¡Œæ•°ï¼š${H.length}</div>
                   <div class="kpi">æ­£è§£ï¼š${H.filter(x=>x.ok).length}</div>
                   <div class="kpi">æ­£ç­”ç‡ï¼š${pct(H.filter(x=>x.ok).length,H.length)}%</div>`;
  hist.innerHTML = H.length? H.map((r,i)=>`<div><strong>${i+1}. [${esc(r.cat)}] ${esc(r.q)}</strong><br>ã‚ãªãŸï¼š${esc(r.ua||'â€”')} / æ­£è§£ï¼š${esc(r.ans)}<br>è§£èª¬ï¼š${esc(r.explain||'â€”')}</div>`).join('') : '<div>ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
  ov.style.display='flex'; ov.setAttribute('aria-hidden','false');
  document.getElementById('closeResult').onclick=()=>{ ov.style.display='none'; ov.setAttribute('aria-hidden','true'); };
}

/* ========= å…¥å£ã®è£œåŠ©ãƒœã‚¿ãƒ³ ========= */
document.getElementById('refreshBtn').onclick = async ()=>{
  const cats = [...document.querySelectorAll('input[data-cat]:checked')].map(el=>el.value);
  await generateQuestions(cats, 300);
  buildQueue(); mountQuestion(); renderRight();
};
document.getElementById('updateBtn').onclick  = ()=> alert('Wikipediaè‡ªå‹•è¿½åŠ ã¯åˆ¥é€”ãƒ‘ãƒƒã‚¯ã¨ã—ã¦ä½µç”¨OKã§ã™ã€‚');

</script>
<script>
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ï¼ˆ?v=æ—¥æ™‚ï¼‰ã‚’ä»˜ã‘ã¦å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å›é¿
  const bgm = new Audio('assets/music/main_bgm.mp3?v=' + Date.now());
  bgm.loop = true;
  bgm.volume = 0.28;
  document.getElementById('btnStart').addEventListener('click', () => {
    bgm.play().catch(e => console.log('å†ç”Ÿã§ãã¾ã›ã‚“:', e));
  });
</script>
</body>
</html>
