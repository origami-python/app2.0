<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>社会クイズ v2.0 + Retro</title>
<meta name="theme-color" content="#d71a1a">
<link rel="manifest" href="./manifest.webmanifest">
<link rel="apple-touch-icon" href="./assets/icon512.png">
<style>
  /* ===== Retro (FC風) 配色・フォント・ドットUI ===== */
  @font-face{
    font-family: "PressStart";
    src: local(""), url("https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nYhD8.woff2") format("woff2");
    font-display: swap;
  }
  :root{
    --bg:#0c0c0c; --card:#141414; --ink:#f2f2f2; --sub:#bfbfbf;
    --acc:#d71a1a; --ok:#2ecc40; --ng:#ff4136; --edge:#2a2a2a; --scan:#2e2e2e;
    --pix:3px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:repeating-linear-gradient(0deg,#0c0c0c 0,#0c0c0c 2px,#0d0d0d 2px,#0d0d0d 4px);
    color:var(--ink); font:15px/1.7 "Noto Sans JP",system-ui,Segoe UI,Arial;
  }
  .crt::before{ /* CRTスキャン風 */
    content:""; position:fixed; inset:0; pointer-events:none; mix-blend-mode:soft-light;
    background:linear-gradient(0deg,rgba(255,255,255,.02) 0,rgba(0,0,0,0) 50%,rgba(255,255,255,.02) 100%);
    background-size:100% 3px;
  }
  header,footer{position:sticky;z-index:5;background:#0b0b0b;border-bottom:1px solid var(--edge)}
  header{top:0} footer{bottom:0;border-bottom:none;border-top:1px solid var(--edge)}
  .bar{max-width:1000px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:8px}
  .title{font-family:"PressStart",monospace; letter-spacing:1px; font-size:12px}
  .badge{background:#222;border:2px solid #444;border-radius:6px;padding:6px 8px}
  .main{max-width:1000px;margin:12px auto 90px;padding:0 12px;display:grid;gap:12px;grid-template-columns:1fr}
  @media(min-width:960px){ .main{ grid-template-columns:1.25fr .75fr; } }
  .card{background:var(--card);border:3px solid var(--edge);border-radius:10px;padding:12px;box-shadow:0 0 0 var(--pix) #000 inset}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button{background:#1a1a1a;border:3px solid #333;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer;box-shadow:inset 0 -4px 0 rgba(0,0,0,.2);font-weight:700}
  button:active{transform:translateY(1px); box-shadow:inset 0 -2px 0 rgba(0,0,0,.25)}
  .primary{background:var(--acc);border-color:#861010}
  .ghost{background:#151515}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:3px solid #333;border-radius:999px;background:#131313;color:#eee;text-decoration:none}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  .tiny{color:var(--sub);font-size:12px}
  .qimg{max-height:220px;width:100%;object-fit:cover;border-radius:8px;border:3px solid #333;display:none}
  .opt{padding:10px;border:3px solid #333;border-radius:8px;cursor:pointer;background:#121212}
  .opt.correct{background:#0f2412;border-color:#1e4d2a}
  .opt.incorrect{background:#2a0f0f;border-color:#5a1f1f}
  .list{display:grid;gap:8px;max-height:320px;overflow:auto}
  .kpi{background:#0f0f0f;border:3px solid #333;border-radius:8px;padding:8px}
  .pack{display:flex;align-items:center;gap:8px;padding:8px;border:3px solid #333;border-radius:8px;background:#101010}
  .yt{display:inline-flex;align-items:center;gap:6px}
  .yt svg{width:16px;height:16px}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
  .dialog{max-width:900px;width:92%;max-height:85vh;overflow:auto;background:#0f0f0f;border:3px solid #333;border-radius:12px;padding:12px}
</style>
</head>
<body class="crt">
<header>
  <div class="bar">
    <div class="title">SOCIAL QUIZ • RETRO</div>
    <div class="badge">v2.0</div>
    <div style="margin-left:auto" class="row">
      <button id="refreshBtn" class="ghost">ローカル読込</button>
      <button id="updateBtn" class="primary">オンライン更新（Wikipedia）</button>
      <button id="musicBtn" class="ghost">♪ オープニング</button>
    </div>
  </div>
</header>

<main class="main">
  <section class="card" id="left"></section>
  <aside class="card" id="right">
    <h3 style="margin:0 0 8px">パック</h3>
    <div id="packs" class="list tiny"></div>
  </aside>
</main>

<footer>
  <div class="bar tiny">
    <div>データ：<code>data/packs/*.json</code> ／ PWA対応（ホーム画面追加OK）</div>
  </div>
</footer>

<!-- 採点モーダル -->
<div id="resultOverlay" class="overlay" aria-hidden="true">
  <div class="dialog">
    <h3>学習結果（今回）</h3>
    <div id="sum" class="row" style="margin:8px 0"></div>
    <div id="hist" class="list tiny"></div>
    <div class="row" style="justify-content:end;margin-top:10px">
      <button class="ghost" id="closeResult">閉じる</button>
    </div>
  </div>
</div>

<script>
/* ================== PWA ================== */
if ('serviceWorker' in navigator) {
  addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.warn));
}

/* ================== WebAudio（レトロ音） ================== */
const SFX = (() => {
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const master = ctx.createGain(); master.gain.value = 0.2; master.connect(ctx.destination);

  function beep(freq=440, t=0.12, type='square'){
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master);
    g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.6, ctx.currentTime+0.01);
    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+t);
    o.start(); o.stop(ctx.currentTime+t+0.01);
  }
  function chord(base=392){ // オープニング3和音
    beep(base, 0.18); setTimeout(()=>beep(base*5/4,0.18),40); setTimeout(()=>beep(base*3/2,0.18),80);
    setTimeout(()=>{beep(base*2,0.22)},180);
  }
  return {
    start: ()=>chord(392),
    select: ()=>beep(660,0.06),
    correct: ()=>{beep(880,0.08); setTimeout(()=>beep(1175,0.09,'triangle'),60)},
    wrong: ()=>{beep(180,0.12,'square'); setTimeout(()=>beep(140,0.14,'square'),80)}
  };
})();
document.getElementById('musicBtn').onclick = ()=> SFX.start();

/* ================== State / Utility ================== */
const APP='socquiz_v2_retro';
const store = {
  data: JSON.parse(localStorage.getItem(APP) || '{"cards":[],"stats":{"answered":0,"correct":0,"streak":0,"points":0},"session":[]}'),
  save(){ localStorage.setItem(APP, JSON.stringify(this.data)); },
  reset(){ localStorage.removeItem(APP); location.reload(); }
};
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]} return a;}
function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function pct(a,b){return !b?0:Math.round(a/b*100);}

/* ================== Pack読み込み（2.0継承） ================== */
async function loadPackIndex(){
  try{ const res=await fetch('./data/index.json?v='+Date.now(),{cache:'no-store'}); if(!res.ok) throw 0; return await res.json(); }
  catch{ return []; }
}
async function loadPacks(selected){
  const base='./data/packs/'; const loaded=[];
  for(const p of selected){
    try{ const r=await fetch(`${base}${p}.json?v=${Date.now()}`,{cache:'no-store'}); if(r.ok) loaded.push(...await r.json()); }catch{}
  }
  const ids=new Set((store.data.cards||[]).map(c=>String(c.id)));
  const add=loaded.filter(q=>!ids.has(String(q.id))).map(q=>({
    id:q.id, domain:q.domain||'総合', question_type:q.question_type||'mc',
    question:q.question, choices:q.choices, answer:q.answer,
    explanation:q.explanation||'', image:q.image||null,
    source:q.source||{type:'pack',note:'packs'}, tags:q.tags||[]
  }));
  store.data.cards.push(...add); store.save(); return add.length;
}
async function renderPackUI(){
  const list=await loadPackIndex(); const el=document.getElementById('packs');
  el.innerHTML = list.length ? '' : '<div>data/index.json が見つかりません</div>';
  list.forEach(p=>{
    const id='pack_'+p.pack;
    el.insertAdjacentHTML('beforeend', `
      <label class="pack">
        <input type="checkbox" id="${id}" data-pack="${p.pack}" ${p.recommended?'checked':''}
               onclick="SFX.select()">
        <div><b>${esc(p.title)}</b><br><span class="tiny">${esc(p.pack)} / ${p.count}問</span></div>
      </label>
    `);
  });
  const btn=document.createElement('button');
  btn.textContent='選択パックを読み込む'; btn.className='primary';
  btn.onclick=async()=>{ const packs=[...document.querySelectorAll('[id^="pack_"]:checked')].map(x=>x.dataset.pack);
    const n=await loadPacks(packs);
    if(n>0){ buildQueue(); mountQuestion(); alert(`${n}問を読み込みました`); } else { alert('新規はありません'); }
  };
  el.appendChild(btn);
}

/* ================== Wikipedia更新（2.0継承） ================== */
const BOOST_TERMS = ['律令制','口分田','平清盛','日宋貿易','元寇','文永の役','弘安の役','町衆','問屋制家内工業','琵琶湖','パリ協定','社会保障','固定資産税','女性参政権','ABCD包囲網','三権分立','国民投票','小選挙区制','比例代表制','アンデス山脈','リマン海流','季節風','憲法改正','直接金融','公企業'];
async function fetchWiki(term){
  const url=`https://ja.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(term)}`;
  const res=await fetch(url,{headers:{accept:'application/json'}}); if(!res.ok) throw 0;
  const j=await res.json();
  return {title:j.title||term, extract:(j.extract||'').replace(/\s+/g,' ').trim(),
          url: j.content_urls?.desktop?.page || `https://ja.wikipedia.org/wiki/${encodeURIComponent(term)}`,
          thumb: j.thumbnail?.source || null};
}
function genMCFromSummary(term,sum){
  const sent=(sum.extract||'').split('。')[0]||`${term}の基礎事項。`;
  const pool=BOOST_TERMS.filter(t=>t!==term); const distractors=shuffle(pool).slice(0,3);
  const choices=shuffle([term,...distractors]);
  return { id:`web_${term}_${Math.random().toString(36).slice(2,7)}`, domain:'自動', question_type:'mc',
    question:`${sent} ……この説明に当てはまる語句は？`,
    choices, answer:term, explanation:`出典: Wikipedia「${sum.title}」要約から自動生成`, image:sum.thumb, source:{type:'url',url:sum.url} };
}
async function onlineUpdate(seed=BOOST_TERMS){
  const results=[]; for(const t of seed){ try{ const s=await fetchWiki(t); results.push(genMCFromSummary(t,s)); }catch{} if(results.length>=20) break; }
  const ids=new Set((store.data.cards||[]).map(c=>c.id)); const add=results.filter(q=>!ids.has(q.id));
  store.data.cards.push(...add); store.save(); alert(`オンライン更新：${add.length}問を追加しました（Wikipedia要約）`);
  render();
}

/* ================== YouTube（@eva11100）連携（1.0復活） ================== */
/* ルール：
   - 問題の正解語句や、question内の主要語を使って @eva11100 チャンネルの検索タブを開く
   - ボタンは対象語が「歴史/年号/文化・地理の固有名」に該当するときに表示
*/
const YT_CHANNEL_SEARCH = (q)=>`https://www.youtube.com/@eva11100/search?query=${encodeURIComponent(q)}`;
function shouldShowYT(qobj){
  const key = qobj.answer || '';
  const hitTag = (qobj.domain||'').match(/歴史|地理|公民/) && (qobj.tags||[]).some(t=>/年号|文化|城|戦|幕府|貿易|山脈|海流|温泉|石川|加賀|金沢/i.test(t));
  const keyHit = /[一-龥A-Za-z0-9]/.test(key) && (qobj.domain === '歴史' || /山脈|海流|城|幕府|戦|貿易|平清盛|元寇|律令|加賀|金沢|九谷|能登/.test(key));
  return keyHit || hitTag;
}

/* ================== Quiz Engine（1.0の挙動維持：回答→解説で停止） ================== */
let queue=[], current=null;
function buildQueue(){ queue = shuffle([...store.data.cards]).slice(0,30); }
function mountQuestion(){
  const L=document.getElementById('left');
  if(!current){ current = queue.shift() || store.data.cards[Math.floor(Math.random()*store.data.cards.length)]; }
  const c=current;
  const ops = Array.isArray(c.choices)
    ? c.choices.map(ch=>`<label class="opt"><input type="radio" name="choice" value="${esc(ch)}"> ${esc(ch)}</label>`).join('')
    : `<input id="free" type="text" placeholder="解答を入力">`;

  const ytBtn = shouldShowYT(c)
    ? `<a class="pill yt" target="_blank" rel="noopener" href="${YT_CHANNEL_SEARCH(c.answer||c.question)}" title="チャンネル内で関連動画を検索">
         <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 16.5l6-4.5-6-4.5v9z"></path><path d="M21.8 8s-.2-1.4-.8-2c-.7-.8-1.6-.8-2-0.9C16.7 5 12 5 12 5h0s-4.7 0-7 .1c-.4 0-1.3.1-2 .9-.6.6-.8 2-.8 2S2 9.6 2 11.3v1.3C2 14.4 2.2 16 2.2 16s.2 1.4.8 2c.7.8 1.7.8 2.1.9 1.5.1 6.9.1 6.9.1s4.7 0 7-.1c.4 0 1.3-.1 2-.9.6-.6.8-2 .8-2s.2-1.6.2-3.3v-1.3C22 9.6 21.8 8 21.8 8z"></path></svg>
         再生
       </a>` : '';

  L.innerHTML = `
    <div class="tiny">出典: ${esc(c.source?.url||c.source?.note||'local')}</div>
    <h3 style="margin:.2rem 0 0.8rem">${esc(c.question)}</h3>
    <img class="qimg" id="qimg" src="${c.image||''}" style="display:${c.image?'block':'none'}">
    <div id="ops" class="list">${ops}</div>
    <div class="row" style="margin-top:10px">
      <button class="primary" id="answerBtn">回答する</button>
      <button class="ghost" id="skipBtn">スキップ</button>
      <button class="pill" id="gradeBtn">採点する</button>
      ${ytBtn}
      ${c.source?.url?`<a class="pill" href="${c.source.url}" target="_blank" rel="noopener">参考リンク</a>`:''}
    </div>
    <div id="fb" style="margin-top:10px"></div>
  `;
  renderRight();
  document.getElementById('answerBtn').onclick = checkAnswer;
  document.getElementById('skipBtn').onclick   = ()=>{ current=null; SFX.select(); mountQuestion(); };
  document.getElementById('gradeBtn').onclick  = openResults;
}
function checkAnswer(){
  const c=current; const fb=document.getElementById('fb');
  let ua='';
  const radio = document.querySelector('input[name="choice"]');
  if(radio){
    const sel=document.querySelector('input[name="choice"]:checked');
    if(!sel){ fb.innerHTML='<div class="tiny">選択肢を選んでね。</div>'; return; }
    ua=sel.value;
    document.querySelectorAll('.opt').forEach(el=>{
      const v=el.querySelector('input').value;
      el.classList.toggle('correct', v===c.answer);
      if(v===ua && ua!==c.answer) el.classList.add('incorrect');
      el.querySelector('input').disabled=true;
    });
  }else{
    ua=(document.getElementById('free').value||'').trim();
  }
  const ok = String(ua)===String(c.answer);
  if(ok){ store.data.stats.correct++; store.data.stats.streak++; store.data.stats.points+=10; SFX.correct(); }
  else { store.data.stats.streak=0; SFX.wrong(); }
  store.data.stats.answered++;
  store.data.session.push({q:c.question, ua, ans:c.answer, ok, explain:c.explanation||'', src:c.source?.url||c.source?.note||''});
  store.save();

  // ★解説を表示し、ここで停止（1.0の挙動）
  fb.innerHTML = `
    <div class="${ok?'ok':'ng'}">${ok?'🎉 正解！ +10pt':'💡 不正解……'}</div>
    <div class="tiny">解説：${esc(c.explanation||'—')}</div>
    <div class="row" style="margin-top:10px">
      <button class="primary" id="nextBtn">次の問題へ</button>
      <button class="ghost" id="gradeNowBtn">採点する</button>
    </div>
  `;
  document.getElementById('nextBtn').onclick=()=>{ current=null; mountQuestion(); };
  document.getElementById('gradeNowBtn').onclick=openResults;
  renderRight();
}

/* ================== 右パネル（進捗・バックアップ） ================== */
function renderRight(){
  const s=store.data.stats, R=document.getElementById('right');
  R.innerHTML = `
    <h3>進捗</h3>
    <div class="row">
      <div class="kpi">解いた数：${s.answered}</div>
      <div class="kpi">正解数：${s.correct}</div>
      <div class="kpi">正答率：${pct(s.correct, s.answered)}%</div>
      <div class="kpi">連続正解：${s.streak}</div>
      <div class="kpi">ポイント：${s.points}</div>
    </div>
    <h3 style="margin-top:12px">操作</h3>
    <div class="row">
      <button class="ghost" onclick="store.reset()">全データ削除</button>
      <button class="ghost" id="backup">バックアップ</button>
      <input type="file" id="restoreFile" style="display:none" accept="application/json">
      <button class="ghost" id="restoreBtn">復元</button>
    </div>
    <h3 style="margin-top:12px">パック</h3>
    <div id="packs" class="list tiny"></div>
  `;
  document.getElementById('backup').onclick=()=>{
    const blob = new Blob([JSON.stringify(store.data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='socquiz_v2_backup.json'; a.click();
  };
  document.getElementById('restoreBtn').onclick=()=>{
    const f=document.getElementById('restoreFile'); f.onchange=()=>{
      const file=f.files[0]; const r=new FileReader();
      r.onload=()=>{ try{ store.data=JSON.parse(r.result); store.save(); location.reload(); }catch{ alert('復元失敗'); } };
      r.readAsText(file);
    }; f.click();
  };
  renderPackUI();
}

/* ================== 採点モーダル（2.0継承） ================== */
function openResults(){
  const ov=document.getElementById('resultOverlay'), sum=document.getElementById('sum'), hist=document.getElementById('hist');
  const S=store.data.stats, H=store.data.session;
  sum.innerHTML = `<div class="kpi">今回の問題数：${H.length}</div>
                   <div class="kpi">正解：${H.filter(x=>x.ok).length}</div>
                   <div class="kpi">正答率：${pct(H.filter(x=>x.ok).length,H.length)}%</div>`;
  hist.innerHTML = H.length? H.map((r,i)=>`<div><strong>${i+1}. ${esc(r.q)}</strong><br>あなた：${esc(r.ua||'—')} / 正解：${esc(r.ans)}<br>解説：${esc(r.explain||'—')} ${r.src?`<a class="pill" href="${r.src}" target="_blank" rel="noopener">参考</a>`:''}</div>`).join('') : '<div>まだ回答がありません。</div>';
  ov.style.display='flex'; ov.setAttribute('aria-hidden','false');
  document.getElementById('closeResult').onclick=()=>{ ov.style.display='none'; ov.setAttribute('aria-hidden','true'); };
}

/* ================== Boot ================== */
document.getElementById('refreshBtn').onclick = ()=>{ if(store.data.cards.length){ buildQueue(); mountQuestion(); } else { alert('まずは右の「選択パックを読み込む」を押してください'); } };
document.getElementById('updateBtn').onclick  = ()=> onlineUpdate();
(function init(){ renderRight(); SFX.start(); })();
</script>
</body>
</html>